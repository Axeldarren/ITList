generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL_POSTGRES")
}

model User {
  userId                   String                 @id @default(uuid())
  username                 String
  email                    String                 @unique
  password                 String
  NIK                      Int?                   @unique
  profilePictureUrl        String?
  department               String?
  role                     String                 @default("DEVELOPER")
  deletedAt                DateTime?
  deletedById              String?
  activities               Activity[]
  deletedAttachments       Attachment[]           @relation("DeletedAttachments")
  attachments              Attachment[]
  deletedComments          Comment[]              @relation("DeletedComments")
  updatedComments          Comment[]              @relation("UpdatedComments")
  authoredComments         Comment[]              @relation("AuthoredComments")
  assignedMaintenanceTasks MaintenanceTask[]      @relation("AssignedMaintenanceTasks")
  createdMaintenanceTasks  MaintenanceTask[]      @relation("CreatedMaintenanceTasks")
  updatedMaintenanceTasks  MaintenanceTask[]      @relation("UpdatedMaintenanceTasks")
  productMaintainers       ProductMaintainer[]
  createdMaintenances      ProductMaintenance[]   @relation("CreatedMaintenances")
  deletedMaintenances      ProductMaintenance[]   @relation("DeletedMaintenances")
  updatedMaintenances      ProductMaintenance[]   @relation("UpdatedMaintenances")
  createdProjects          Project[]              @relation("CreatedProjects")
  deletedProjects          Project[]              @relation("DeletedProjects")
  updatedProjects          Project[]              @relation("UpdatedProjects")
  statusChanges            ProjectStatusHistory[]
  assignedTasks            Task[]                 @relation("AssignedTasks")
  authoredTasks            Task[]                 @relation("AuthoredTasks")
  deletedTasks             Task[]                 @relation("DeletedTasks")
  updatedTasks             Task[]                 @relation("UpdatedTasks")
  taskAssignments          TaskAssignment[]
  createdTeams             Team[]                 @relation("CreatedTeams")
  deletedTeams             Team[]                 @relation("DeletedTeams")
  updatedTeams             Team[]                 @relation("UpdatedTeams")
  teams                    TeamMembership[]
  timeLogs                 TimeLog[]
  maintenanceStatusChanges ProductMaintenanceStatusHistory[]
  staffId                 Int?                   @unique // Optional staff ID for linking with external systems

  @@map("User")
}

model Project {
  id                  Int                    @id @default(autoincrement())
  name                String
  description         String?                @db.Text
  docUrl              String?                @db.Text
  startDate           DateTime?
  endDate             DateTime?
  version             Int                    @default(1)
  createdAt           DateTime               @default(now())
  createdById         String?
  deletedAt           DateTime?
  deletedById         String?
  status              ProjectStatus          @default(Start)
  updatedAt           DateTime               @default(now()) @updatedAt
  updatedById         String?
  activities          Activity[]
  productMaintenances ProductMaintenance[]
  createdBy           User?                  @relation("CreatedProjects", fields: [createdById], references: [userId])
  deletedBy           User?                  @relation("DeletedProjects", fields: [deletedById], references: [userId])
  updatedBy           User?                  @relation("UpdatedProjects", fields: [updatedById], references: [userId])
  statusHistory       ProjectStatusHistory[]
  projectTeams        ProjectTeam[]
  versions            ProjectVersion[]
  tasks               Task[]
  projectTicket       ProjectTicket?         @relation("ProjectToProjectTicket")

  @@index([createdById])
  @@index([deletedById])
  @@index([updatedById])
  @@map("Project")
}

model ProjectStatusHistory {
  id          Int           @id @default(autoincrement())
  projectId   Int
  status      ProjectStatus
  changedAt   DateTime      @default(now())
  changedById String
  changedBy   User          @relation(fields: [changedById], references: [userId])
  project     Project       @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([changedById])
  @@map("ProjectStatusHistory")
}

model Task {
  id              Int              @id @default(autoincrement())
  title           String
  description     String?          @db.Text
  status          String?
  priority        String?
  tags            String?
  startDate       DateTime?
  dueDate         DateTime?
  points          Int?
  version         Int
  projectId       Int
  authorUserId    String
  assignedUserId  String?
  createdAt       DateTime         @default(now())
  deletedAt       DateTime?
  deletedById     String?
  updatedAt       DateTime         @default(now()) @updatedAt
  updatedById     String?
  activities      Activity[]
  attachments     Attachment[]
  comments        Comment[]
  assignee        User?            @relation("AssignedTasks", fields: [assignedUserId], references: [userId])
  author          User             @relation("AuthoredTasks", fields: [authorUserId], references: [userId])
  deletedBy       User?            @relation("DeletedTasks", fields: [deletedById], references: [userId])
  project         Project          @relation(fields: [projectId], references: [id], onDelete: Cascade)
  updatedBy       User?            @relation("UpdatedTasks", fields: [updatedById], references: [userId])
  taskAssignments TaskAssignment[]
  timeLogs        TimeLog[]

  @@index([assignedUserId])
  @@index([authorUserId])
  @@index([deletedById])
  @@index([projectId])
  @@index([updatedById])
  @@map("Task")
}

model Comment {
  id          Int       @id @default(autoincrement())
  text        String    @db.Text
  taskId      Int?      // Make optional to support maintenance tasks
  userId      String
  createdAt   DateTime  @default(now())
  deletedAt   DateTime?
  deletedById String?
  updatedAt   DateTime  @default(now()) @updatedAt
  updatedById String?
  
  // Add maintenance task support
  maintenanceTaskId   Int?
  maintenanceTask     MaintenanceTask?   @relation(fields: [maintenanceTaskId], references: [id], onDelete: Cascade)
  
  deletedBy   User?     @relation("DeletedComments", fields: [deletedById], references: [userId])
  task        Task?     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  updatedBy   User?     @relation("UpdatedComments", fields: [updatedById], references: [userId])
  user        User      @relation("AuthoredComments", fields: [userId], references: [userId])
  timeLog     TimeLog?  @relation("TimeLogComment")

  @@index([deletedById])
  @@index([taskId])
  @@index([updatedById])
  @@index([userId])
  @@index([maintenanceTaskId])
  @@map("Comment")
}

model Team {
  id                   Int              @id @default(autoincrement())
  teamName             String
  productOwnerUserId   String?
  projectManagerUserId String?
  createdAt            DateTime         @default(now())
  createdById          String?
  deletedAt            DateTime?
  deletedById          String?
  updatedAt            DateTime         @default(now()) @updatedAt
  updatedById          String?
  projectTeams         ProjectTeam[]
  createdBy            User?            @relation("CreatedTeams", fields: [createdById], references: [userId])
  deletedBy            User?            @relation("DeletedTeams", fields: [deletedById], references: [userId])
  updatedBy            User?            @relation("UpdatedTeams", fields: [updatedById], references: [userId])
  members              TeamMembership[]

  @@index([createdById])
  @@index([deletedById])
  @@index([updatedById])
  @@map("Team")
}

model TimeLog {
  id        Int       @id @default(autoincrement())
  startTime DateTime
  endTime   DateTime?
  duration  Int?
  description String? // Add description field
  createdAt DateTime  @default(now())
  taskId    Int?      // Make optional to support maintenance tasks
  userId    String
  commentId Int?      @unique
  
  // Add maintenance task support
  maintenanceTaskId   Int?
  maintenanceTask     MaintenanceTask?   @relation(fields: [maintenanceTaskId], references: [id], onDelete: Cascade)
  
  comment   Comment?  @relation("TimeLogComment", fields: [commentId], references: [id])
  task      Task?     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user      User      @relation(fields: [userId], references: [userId])

  @@index([taskId])
  @@index([userId])
  @@index([maintenanceTaskId])
  @@map("TimeLog")
}

model ProjectVersion {
  id          Int           @id @default(autoincrement())
  version     Int
  name        String
  description String?
  startDate   DateTime
  endDate     DateTime
  archivedAt  DateTime      @default(now())
  status      ProjectStatus @default(Finish)
  projectId   Int
  project     Project       @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@map("ProjectVersion")
}

model Activity {
  id          Int          @id @default(autoincrement())
  type        ActivityType
  description String
  createdAt   DateTime     @default(now())
  projectId   Int
  userId      String
  taskId      Int?
  project     Project      @relation(fields: [projectId], references: [id], onDelete: Cascade)
  task        Task?        @relation(fields: [taskId], references: [id])
  user        User         @relation(fields: [userId], references: [userId])

  @@index([projectId])
  @@index([taskId])
  @@index([userId])
  @@map("Activity")
}

model TeamMembership {
  id     Int  @id @default(autoincrement())
  userId String
  teamId Int
  team   Team @relation(fields: [teamId], references: [id], onDelete: Cascade)
  user   User @relation(fields: [userId], references: [userId])

  @@unique([userId, teamId])
  @@index([teamId])
  @@map("TeamMembership")
}

model ProjectTeam {
  id        Int     @id @default(autoincrement())
  teamId    Int
  projectId Int
  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  team      Team    @relation(fields: [teamId], references: [id])

  @@index([projectId])
  @@index([teamId])
  @@map("ProjectTeam")
}

model TaskAssignment {
  id     Int  @id @default(autoincrement())
  userId String
  taskId Int
  task   Task @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user   User @relation(fields: [userId], references: [userId])

  @@index([taskId])
  @@index([userId])
  @@map("TaskAssignment")
}

model Attachment {
  id           Int       @id @default(autoincrement())
  fileURL      String    @db.Text
  fileName     String?
  taskId       Int
  uploadedById String
  createdAt    DateTime  @default(now())
  deletedAt    DateTime?
  deletedById  String?
  deletedBy    User?     @relation("DeletedAttachments", fields: [deletedById], references: [userId])
  task         Task      @relation(fields: [taskId], references: [id], onDelete: Cascade)
  uploadedBy   User      @relation(fields: [uploadedById], references: [userId])

  @@index([deletedById])
  @@index([taskId])
  @@index([uploadedById])
  @@map("Attachment")
}

model ProductMaintenance {
  id               Int                      @id @default(autoincrement())
  name             String
  description      String?                  @db.Text
  status           ProductMaintenanceStatus @default(Active)
  lifecycle        MaintenanceLifecycle      @default(Planned)
  priority         String?                  @default("Medium")
  projectId        Int?
  createdAt        DateTime                 @default(now())
  updatedAt        DateTime                 @default(now()) @updatedAt
  createdById      String
  updatedById      String?
  deletedAt        DateTime?
  deletedById      String?
  maintenanceTasks MaintenanceTask[]
  maintainers      ProductMaintainer[]
  createdBy        User                     @relation("CreatedMaintenances", fields: [createdById], references: [userId])
  deletedBy        User?                    @relation("DeletedMaintenances", fields: [deletedById], references: [userId])
  project          Project?                 @relation(fields: [projectId], references: [id])
  updatedBy        User?                    @relation("UpdatedMaintenances", fields: [updatedById], references: [userId])
  statusHistory    ProductMaintenanceStatusHistory[]

  @@index([createdById])
  @@index([deletedById])
  @@index([projectId])
  @@index([updatedById])
  @@map("ProductMaintenance")
}

model MaintenanceTask {
  id                   Int                @id @default(autoincrement())
  title                String
  description          String?            @db.Text
  priority             String?            @default("Medium")
  type                 String
  estimatedHours       Int?
  actualHours          Int?
  productMaintenanceId Int
  assignedToId         String?
  createdAt            DateTime           @default(now())
  updatedAt            DateTime           @default(now()) @updatedAt
  createdById          String
  updatedById          String?
  
  // Add missing relationships
  timeLogs             TimeLog[]          // Relationship to TimeLog
  comments             Comment[]          // Relationship to Comment
  maintenanceTaskTicket MaintenanceTaskTicket? @relation("MaintenanceTaskToMaintenanceTaskTicket")
  
  assignedTo           User?              @relation("AssignedMaintenanceTasks", fields: [assignedToId], references: [userId])
  createdBy            User               @relation("CreatedMaintenanceTasks", fields: [createdById], references: [userId])
  productMaintenance   ProductMaintenance @relation(fields: [productMaintenanceId], references: [id], onDelete: Cascade)
  updatedBy            User?              @relation("UpdatedMaintenanceTasks", fields: [updatedById], references: [userId])

  @@index([productMaintenanceId])
  @@index([assignedToId])
  @@index([createdById])
  @@index([updatedById])
  @@map("MaintenanceTask")
}

model ProductMaintainer {
  id                   Int                @id @default(autoincrement())
  productMaintenanceId Int
  userId               String
  role                 String             @default("Maintainer")
  createdAt            DateTime           @default(now())
  productMaintenance   ProductMaintenance @relation(fields: [productMaintenanceId], references: [id], onDelete: Cascade)
  user                 User               @relation(fields: [userId], references: [userId])

  @@unique([productMaintenanceId, userId])
  @@index([userId])
  @@map("ProductMaintainer")
}

enum ProjectStatus {
  Start
  OnProgress
  Resolve
  Finish
  Cancel
}

enum ProductMaintenanceStatus {
  Active
  Inactive
}

enum MaintenanceLifecycle {
  Planned
  Maintaining
  Finished
}

model ProductMaintenanceStatusHistory {
  id                   Int                  @id @default(autoincrement())
  productMaintenanceId Int
  status               MaintenanceLifecycle
  changedAt            DateTime             @default(now())
  changedById          String
  changedBy            User                 @relation(fields: [changedById], references: [userId])
  productMaintenance   ProductMaintenance   @relation(fields: [productMaintenanceId], references: [id], onDelete: Cascade)

  @@index([productMaintenanceId])
  @@index([changedById])
  @@map("ProductMaintenanceStatusHistory")
}

enum ActivityType {
  TASK_CREATED
  TASK_STATUS_UPDATED
  COMMENT_ADDED
  TASK_UPDATED
  TASK_DELETED
}

model ProjectTicket {
    id         Int      @id @default(autoincrement())
    ticket_id  String   @unique // Ensure a ticket cannot be associated with multiple projects
    projectId  Int      @unique // Ensure a project cannot have multiple tickets
    createdAt  DateTime @default(now())
    version    Int      @default(1)

    project     Project  @relation("ProjectToProjectTicket", fields: [projectId], references: [id], onDelete: Cascade)

    @@unique([projectId, version])
    @@unique([ticket_id, version])
    @@map("ProjectTicket")
}

model MaintenanceTaskTicket {
    id                   Int      @id @default(autoincrement())
    ticket_id            String   @unique // Ensure a ticket cannot be associated with multiple maintenance tasks
    maintenanceTaskId    Int      @unique // Ensure a maintenance task cannot have multiple tickets
    createdAt            DateTime @default(now())

    maintenanceTask      MaintenanceTask @relation("MaintenanceTaskToMaintenanceTaskTicket", fields: [maintenanceTaskId], references: [id], onDelete: Cascade)

    @@map("MaintenanceTaskTicket")
}
